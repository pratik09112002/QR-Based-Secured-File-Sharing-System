<!DOCTYPE html>
<html>
<head>
    <title>QR Code Generated</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .dark-mode .btn {
            border-color: #ccc;
        }

        #reuploadBtn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .reupload-glow {
            animation: glow 1.2s infinite;
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); }
            50% { box-shadow: 0 0 15px rgba(0, 123, 255, 0.9); }
            100% { box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); }
        }

        .dark-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.2rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light" id="mainBody">
<div class="container mt-5 text-center">
    <div class="dark-toggle" onclick="toggleDarkMode()">üåì</div>

    <h2 class="mb-4 text-success">‚úÖ QR Code Generated Successfully!</h2>
    <p class="fw-semibold">{{ message }}</p>

    <!-- QR Code display -->
    <img src="{{ url_for('static', filename='qrcodes/' + qr_filename) }}"
         class="img-fluid rounded shadow"
         style="max-width: 300px;" alt="QR Code">

    <p class="text-muted mt-3">
        üì± Scan this QR code on another device and enter the password to decrypt and download the file.
    </p>

    <!-- Download QR -->
    <a href="{{ url_for('static', filename='qrcodes/' + qr_filename) }}"
       class="btn btn-outline-primary mt-3"
       download>‚¨áÔ∏è Download QR Code</a>

    <hr class="my-4">

    <!-- Re-upload section -->
    <div class="mt-4">
        <p id="waitMsg" class="fw-bold text-warning">
            ‚è≥ Please wait <span id="timer">02:00</span> or until the file is downloaded.
        </p>
        <a href="/" class="btn btn-secondary mt-2" id="reuploadBtn" disabled>üîÅ Re-upload Another File</a>
    </div>
</div>

<!-- JavaScript for countdown and download check -->
<script>
    const fileId = "{{ file_id }}";
    const createdAt = Number("{{ created_at }}") * 1000 || Date.now();
    const now = Date.now();
    let totalSeconds = Math.max(0, Math.floor((createdAt + 120000 - now) / 1000));

    const timerEl = document.getElementById('timer');
    const waitMsg = document.getElementById('waitMsg');
    const reuploadBtn = document.getElementById('reuploadBtn');

    let timerExpired = false;
    let fileDownloaded = false;

    function updateTimerDisplay() {
        const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
        const seconds = String(totalSeconds % 60).padStart(2, '0');
        timerEl.textContent = `${minutes}:${seconds}`;
    }

    function checkEnableReupload() {
        if (fileDownloaded || timerExpired) {
            reuploadBtn.disabled = false;
            reuploadBtn.classList.add('reupload-glow');
            waitMsg.classList.remove('text-warning');
            waitMsg.classList.add('text-success');
            waitMsg.innerText = fileDownloaded
                ? "‚úÖ File downloaded. You can now re-upload."
                : "‚è±Ô∏è Timer expired. You can now re-upload.";

            clearInterval(countdownInterval);
            clearInterval(downloadCheckInterval);
        }
    }

    const countdownInterval = setInterval(() => {
        if (totalSeconds > 0) {
            totalSeconds--;
            updateTimerDisplay();
        } else if (!timerExpired) {
            timerExpired = true;
            checkEnableReupload();
        }
    }, 1000);

    const downloadCheckInterval = setInterval(() => {
        fetch(`/check_download/${fileId}`)
            .then(res => res.json())
            .then(data => {
                if (data.downloaded && !fileDownloaded) {
                    fileDownloaded = true;
                    checkEnableReupload();
                }
            })
            .catch(err => {
                console.error("Error checking download:", err);
            });
    }, 3000);

    function toggleDarkMode() {
        document.getElementById('mainBody').classList.toggle('dark-mode');
    }

    updateTimerDisplay();
</script>
</body>
</html>
